# خطة تنفيذية شاملة لمعالجة النقصانات والتحسينات

## التاريخ: 7-1-2026م

## مقدمة
بناءً على مراجعة ملفات TODO.md وTODO-NEW.md، تم وضع خطة تنفيذية شاملة لمعالجة النقصانات في منطق التقارير والتحسينات المطلوبة. الخطة تركز على الأولويات العالية أولاً، مع تقسيم العمل إلى مراحل منطقية.

---

## المرحلة الأولى: إصلاحات منطق التقارير الأساسية (أولوية عالية)

### 1. صافي المشتريات (Net Purchases)
- [ ] إصلاح منطق المطابقة للمفاتيح 6, 7, 8 مع تطبيق أولوية "تاريخ الصلاحية الأقرب"
- [ ] تعديل معالجة المرتجعات اليتيمة لتكون بكميات سالبة في القائمة الرئيسية
- [ ] إضافة عمود "الإجمالي" (Total) وعمود "رقم السجل"
- [ ] تطبيق الفرز النهائي متعدد المستويات (تاريخ العملية، م، تاريخ الصلاحية)

### 2. صافي المبيعات (Net Sales)
- [ ] إصلاح منطق المطابقة للمفتاح 1 مع شرط "تاريخ المرتجع >= تاريخ البيع"
- [ ] إصلاح منطق المطابقة للمفاتيح 7, 8, 9, 10 مع أولوية "تاريخ الصلاحية الأقرب"
- [ ] تعديل معالجة المرتجعات اليتيمة
- [ ] إضافة أعمدة "الإجمالي" و"رقم السجل"
- [ ] تطبيق الفرز النهائي متعدد المستويات

### 3. الجرد الفعلي (Physical Inventory)
- [ ] إصلاح عمود "رقم السجل" ليكون "رقم سجل المشتريات المطابق"

### 4. فائض المخزون (Excess Inventory)
- [ ] إصلاح صيغة "نسبة المبيعات" إلى "المبيعات (90 يوم) / الكمية"
- [ ] تعديل عتبات "بيان الفائض" إلى >1 و <-1
- [ ] تغيير مصطلح "مناسب" إلى "مثالي"
- [ ] إعادة تسمية عمود "معد للارجاع" إلى "مخزون زائد"

### 5. المخزون النهائي (Ending Inventory)
- [ ] إصلاح حساب "مخزون مثالي" ليساوي "مبيعات 90 يوم"
- [ ] توحيد تسمية الأعمدة مع الوثيقة
- [ ] تصحيح نطاقات "بيان الصلاحية"

### 6. المخزون الدفتري (Book Inventory)
- [ ] إعادة كتابة منطق المطابقة بالكامل حسب الـ4 مفاتيح المحددة
- [ ] تصفية المشتريات المطابقة بالفعل في المخزون النهائي
- [ ] إصلاح هيكل المخرجات والأعمدة
- [ ] تنفيذ تحديثات "ملاحظات" و"رقم السجل"

### 7. تكلفة المبيعات (Sales Cost)
- [ ] إعادة كتابة منطق المطابقة حسب الـ4 مفاتيح
- [ ] إصلاح صيغة "نسبة الربح" إلى "التكلفة / السعر"
- [ ] تحسين استخدام بيانات المبيعات المقسمة

### 8. ربحية الأصناف (Item Profitability)
- [ ] إضافة جميع الأعمدة المفقودة (معلومات الصنف، مقاييس الربحية، مقاييس المخزون، التوصيات)
- [ ] إصلاح صيغة "هامش الربح" لتكون على المبيعات

### 9. ملخص الحسابات الرئيسية (Main Accounts Summary)
- [ ] إصلاح صيغة "صافي الفجوة" إلى "قيمة المخزون - الرصيد"
- [ ] إضافة أعمدة الحالة المفقودة
- [ ] توحيد تسمية الأعمدة

### 10. توقعات مخاطر انتهاء الصلاحية (Expiry Risk)
- [ ] إضافة جميع الأعمدة المفقودة (التحليل المالي، خطة العمل، المراقبة)
- [ ] تطوير منطق التحليل المتقدم

---

## المرحلة الثانية: إصلاحات عرض التقارير وواجهة المستخدم

### 1. إعادة ترتيب أعمدة التقارير
- [ ] صافي المشتريات: م، رمز المادة، اسم المادة، الوحدة، الكمية، الافرادي، الإجمالي، تاريخ الصلاحية، المورد، تاريخ العملية، نوع العملية، رقم السجل، كمية الجرد، كمية المبيعات، ملاحظات، القائمة
- [ ] صافي المبيعات: م، رمز المادة، اسم المادة، الوحدة، الكمية، الافرادي، الإجمالي، تاريخ الصلاحية، تاريخ العملية، نوع العملية، رقم السجل، ملاحظات، القائمة
- [ ] فائض المخزون: رمز المادة، اسم المادة، الوحدة، الكمية، كمية المشتريات، كمية المبيعات، المبيعات، نسبة المبيعات، فائض المخزون، نسبة الفائض، معد للارجاع، الاحتياج، بيان الفائض
- [ ] المخزون النهائي: م، رمز المادة، اسم المادة، الوحدة، الكمية، الافرادي، الاجمالي، تاريخ الصلاحية، المورد، تاريخ الشراء، عمر الصنف، كمية المبيعات، مخزون مثالي، فائض المخزون، معد للارجاع، صنف جديد، الاحتياج، نسبة الفائض، بيان الصلاحية، بيان الحركة، بيان الحالة، البيان، قيمة مخزون مثالي، قيمة فائض المخزون، قيمة معد للارجاع، قيمة صنف جديد، قيمة الاحتياج، القائمة، رقم السجل، ملاحظات
- [ ] استحقاق الموردين: م، رمز الحساب، المورد، مدين، دائن، الرصيد، الحساب المساعد، قيمة المخزون، الاستحقاق، المبلغ المستحق، مخزون مثالي، الحد الأعلى، بيان الاستحقاق، فائض المخزون، معد للارجاع، اصناف جديدة، الاحتياج، منتهي، راكد تماما، قريب جدا، مخزون زائد
- [ ] ربحية الأصناف: م، رمز المادة، اسم المادة، الوحدة، عدد عمليات البيع، إجمالي الكمية المباعة، إجمالي قيمة المبيعات، إجمالي تكلفة المبيعات، إجمالي الربح، نسبة هامش الربح %، نسبة المساهمة في أرباح الشركة %، بيان الربحية
- [ ] مخاطر انتهاء الصلاحية: م، رمز المادة، اسم المادة، الوحدة، رقم السجل، الكمية الحالية، تاريخ الصلاحية، الأيام المتبقية، معدل البيع اليومي، الكمية المتوقعة للبيع، الخطر المتوقع، نسبة الخطر %، بيان الانتهاء

### 2. تحسين عرض الأعمدة
- [ ] ضبط حجم الأعمدة تلقائياً حسب المحتوى مع الحد الأقصى المحدد في الجدول
- [ ] ضبط رؤوس الجداول لتكون بنفس مستوى الأعمدة
- [ ] إزالة التكرار في الأعمدة والرؤوس

### 3. أدوات التبديل (NavigationTabs)
- [ ] تنفيذ حسب عمود "بيان الحالة" للمخزون النهائي (معد للارجاع، صنف جديد، جيد)
- [ ] تنفيذ حسب عمود "بيان الاستحقاق" لاستحقاق الموردين
- [ ] تنفيذ حسب عمود "بيان الربحية" لربحية الأصناف
- [ ] تنفيذ حسب عمود "بيان الانتهاء" لمخاطر انتهاء الصلاحية

### 4. أزرار التصدير
- [ ] التأكد من وجود 3 خيارات تصدير لجميع التقارير (Excel، PDF، طباعة)
- [ ] التأكد من تصدير جميع الأعمدة بدون استثناء
- [ ] تنسيق حجم الأعمدة في Excel بالاحتواء التلقائي

---

## المرحلة الثالثة: ميزات جديدة وتحسينات

### 1. وضع التركيز (Focus Mode)
- [ ] إخفاء القوائم الجانبية عبر CSS

### 2. تثبيت الأعمدة (Column Pinning)
- [ ] استخدام خاصية sticky للأعمدة المهمة

### 3. تلميحات شرح الأعمدة (Column Tooltips)
- [ ] إضافة نصوص توضيحية عند مرور الفأرة

### 4. التنسيق الشرطي البسيط (Conditional Formatting)
- [ ] تلوين الخلايا حسب القيم (أحمر للسلبي، أخضر للإيجابي)

### 5. البحث الصوتي (Voice Search)
- [ ] دمج Web Speech API للبحث الصوتي

---

## المرحلة الرابعة: أمان ونسخ احتياطي

### 1. واجهة النسخ الاحتياطي
- [ ] تصميم صندوق "النسخ الاحتياطي والاستعادة"
- [ ] أزرار: نسخ احتياطي للنظام، نسخ احتياطي كامل، استعراض
- [ ] حقل عرض وتعديل مسار الحفظ
- [ ] حفظ آخر مسار مستخدم

### 2. زر لطي قائمة الصفحات
- [ ] إضافة زر طي/إلغاء طي القائمة العمودية

---

## المرحلة الخامسة: تحسينات الأداء

### 1. تحسينات عالية الأولوية
- [ ] تحسين دالة `calculateReportsAsync` في `App.jsx` لتفريغ الذاكرة دورياً
- [ ] تحسين `PeriodicMemoryManager` لإدارة الموارد
- [ ] تحسين دالة `merge` في `App.jsx`
- [ ] إضافة ميكانيزمات إلغاء للعمليات الطويلة

### 2. تحسينات متوسطة الأولوية
- [ ] لوحة مراقبة الأداء (Performance Dashboard)
- [ ] تحسين تخزين IndexedDB
- [ ] مؤشرات تقدم مفصلة
- [ ] تحسين التصفية والفرز للمصفوفات الكبيرة
- [ ] Batch Updates لتقليل تحديثات واجهة المستخدم

### 3. تحسينات منخفضة الأولوية
- [ ] تحليل حجم الحزمة
- [ ] تحسين ترتيب التحميل
- [ ] تحسين CSS غير المستخدم
- [ ] تحسين تحميل الصور
- [ ] تحسين منطق التقدم

---

## المرحلة السادسة: اختبار وتوثيق

### 1. اختبار التقارير المعدلة
- [ ] تشغيل التطبيق واختبار جميع التقارير
- [ ] استيراد ملف بيانات حقيقي (smallSample.xlsx)
- [ ] التحقق من ظهور الأسماء والأعمدة بشكل صحيح
- [ ] اختبار التصدير والطباعة

### 2. توثيق النتائج
- [ ] توثيق نتائج الاختبار
- [ ] تحديث التعليقات بالعربية
- [ ] توثيق التغييرات في ملفات المنطق

---

## الأولويات والجدول الزمني

### الأسبوع 1-2: المرحلة الأولى (إصلاحات منطق التقارير)
### الأسبوع 3: المرحلة الثانية (عرض التقارير وواجهة المستخدم)
### الأسبوع 4: المرحلة الثالثة (ميزات جديدة)
### الأسبوع 5: المرحلة الرابعة (أمان ونسخ احتياطي)
### الأسبوع 6: المرحلة الخامسة (تحسينات الأداء)
### الأسبوع 7: المرحلة السادسة (اختبار وتوثيق)

---

## المتطلبات والاعتمادات
- الالتزام بتطبيق المنطق المحاسبي كما في `FinalAccountinglogic.md`
- الحفاظ على التوافق مع الإصدارات الحالية
- اختبار كل تغيير في بيئة تجريبية
- توثيق كل تغيير مع تاريخ التعديل
- ترجمة التعليقات إلى العربية

---

## المخاطر والحلول
- **مخاطر الأداء:** حلها بتحسينات الأداء المخططة
- **مخاطر التوافق:** اختبار شامل قبل النشر
- **مخاطر البيانات:** نسخ احتياطي منتظم
- **مخاطر الوقت:** تقسيم العمل إلى مراحل صغيرة

---

## الخطوة التالية
انتظار موافقة المستخدم على الخطة لبدء التنفيذ بالمرحلة الأولى.
