أهم نقاط القصور (الضعف) — مرتبة بحسب الأثر

    اكتمال المنطق الوارد في Accountinglogic.md
        بعض خطوات صريحة في المستند (مثلاً: بناء قوائم A–F، قواعد نقل القوائم اليتيمة إلى صافي الجهتين، مفاتيح مطابقة مرتبة حتى 10 مستويات لكل من NetPurchases وNetSales، أعمدة محددة بدقة في تقارير نهائية مثل Supplier payables وفائض المخزون) غير مغطاة أو لم أعثر على تنفيذ كامل لها في الشيفرة الحالية.
    تدقيق وجود وسلامة البيانات عند الاستيراد
        المواصفات تحدد أسماء أوراق Excel وجداولها وأشكال الحقول (تواريخ بصيغة yyyy-mm-dd، أرقام بدون كسور لأعمدة مالية، إلخ). الشيفرة الحالية لا تظهر طبقة تحقق صارمة (schema validation) قبل بدء التحليل.
    إدارة حالات الحافة (orphan returns، كميات سالبة، صلاحيات منتهية، مواد جديدة)
        المستند يتطلب قوائم مخصصة لهذه الحالات (مثلاً قائمة B: مرتجعات مشتريات يتيـمة، قائمة D: مرتجعات مبيعات يتيـمة). التنفيذ الحالي يتعامل مع بعض الحالات لكن ليس بمستوى قاعدة القواعد المفصَّلة في المستند، ولا توجد آلية واضحة لتتبع أصل كل سجل (رقم السجل المرجعي).
    تتبع الارتباطات (رقم السجل) وتعديل السجلات
        المستند يشترط مطابقة وتبادل أرقام السجل بين صافي المشتريات والجرد الفعلي. الحالي يملأ بعض الحقول لكن لا يوجد ضمان لكون العمليات ثنائية الاتجاه ومعدلة بشكل متناسق لجميع القوائم.
    دقة الأرقام المالية والتقريب
        المواصفات تطلب أرقام صحيحة بدون كسور لبعض الأعمدة المالية (00 format). الشيفرة تستخدم أعداد عائمة دون سياسة واضحة للروند/تحديد الدقة أو استخدام مكتبة عددية دقيقة (Decimal).
    توليد تقارير نهائية فقط إذا توفرت البيانات اللازمة
        لا توجد حماية كافية تمنع إنشاء تقارير مفصلة حين تكون بيانات الإدخال ناقصة أو غير متوافقة مع المواصفات.
    اختبارات وحدات وتكامل غائبة/محدودة
        لا توجد مجموعات اختبارات تغطي المفاتيح العشرة للمطابقة، حالات اليتيم، أو الأداء عند ملفات Excel كبيرة.
    أداء المنطق المطابق
        خوارزمية المطابقة الحالية تبدو حلقات متداخلة (loop داخل loop) على قوائم الشراء والجرد، ما يعرّضها لأداء سيئ على مجموعات بيانات كبيرة (O(n*m)). لا يوجد استخدام لهياكل فهرسة (hash maps) أو فرز مسبق بطريقة تضمن كفاءة.

أولويات الإصلاح (موصى بها)

    أولوية عالية (1–2 أسابيع عمل): تحقيق المطابقة 1:1 مع بنود Accountinglogic.md الحساسة وظيفياً
        إضافة تحقق صارم (schema validation) لملفات Excel عند الاستيراد — رفض/تنبيه إذا فقدت أعمدة مطلوبة أو صيغ تواريخ/أرقام غير صحيحة.
        إكمال (أو التأكد من) منطق NetPurchases وNetSales وفق مفاتيح المطابقة العشرة كما في المستند، مع إخراج القوائم A–F وبيان الانتقالات (orphan returns → netPurchases).
        إكمال منطق تصنيع Ending Inventory (قوائم A–E وB updates) والتحقق من قواعد تعديل كميات صافي المشتريات وربط أرقام السجل كما هو موضح.
        إضافة حِماية صريحة تمنع توليد أي تقرير محاسبي/مالي إذا لم تتوفر البيانات المطلوبة أو إذا فشلت قواعد التحقق.
    أولوية متوسطة (2–4 أسابيع): تحسين الدقة والأتمتة والاختبارات
        استخدام نوع عددٍ دقيق (decimal) للمال/حسابات نهائية وسياسة rounding موثقة.
        إضافة نظام تتبع أُصول السجلات (traceability): لكل سجل نُخزن مصدره/رقم الملف/رقم السجل القديم/الجديد.
        بناء مجموعة اختبارات وحدات وتكامل شاملة تغطي حالات اليتيم/سالب/صلاحية منتهية.
    أولوية منخفضة (بعد التشغيل المستقر): تحسين الأداء على ملفات كبيرة وتجربة المستخدم
        فهرسة/ماب (hash maps) للمطابقة، عمليات streaming على Excel، وتصميم إعدادات لlimit/chunk processing.
        تقارير تحليلية إضافية شرط وجود بيانات داعمة — لا إضافة تقارير جديدة إلا بعد توفير مصادر بيانات متطابقة ومواصفات.

خطة تنفيذ مفصّلة لتحقيق 100% من محتويات Accountinglogic.md (خطوات قابلة للتنفيذ، مع معايير قبول) ملاحظة: كل بند أدناه يجب أن يُنفَّذ مع اختبار/دليل (fixtures) يثبت مطابقته للمواصفات.

المرحلة A — إعداد البنية والملفات (3–5 أيام)

    مهمة A1 — Spec-to-Model mapping
        تحويل كل بنود Accountinglogic.md إلى user stories/مهام صغيرة (issue لكل بند رئيسي).
        ناتج مقبول: قائمة issues مرقمة تغطي كل بند (مثال: "FR-04: NetPurchases — تطبيق 10 مفاتيح مطابقة").
    مهمة A2 — تعريف schema للتحقق
        تعريف JSON schema لكل جدول (purchases, Sales, Physical_Inventory, supplierbalances) يطابق الأعمدة وأنواعها بدقة (تواريخ، أرقام، نص).
        ناتج مقبول: مكتبة تحقق (مثلاً باستخدام joi أو ajv) قابلة للتشغيل قبل المعالجة.

المرحلة B — استيراد البيانات والتحقق (1 أسبوع)

    مهمة B1 — طبقة استيراد Excel
        التأكد من قراءة الأوراق والأسماء المذكورة (مشتريات → purchases، مبيعات → Sales، المخزون → Physical_Inventory، الارصدة → supplierbalances).
        التحقق من وجود Excel Table داخل الورقة، والتعامل مع مشاكل التسمية.
        ناتج مقبول: العملية ترفض الملف مع رسالة خطأ مفهومة إذا لم يطابق schema.
    مهمة B2 — تطبيع البيانات
        توحيد صيغ التواريخ (yyyy-mm-dd)، تحويل أرقام، إزالة مسافات، مع توثيق الحقول المعدلة.
        ناتج مقبول: عينات مدخلة تظهر التواريخ والأرقام بالتنسيق المطلوب.

المرحلة C — بناء NetPurchases وNetSales (2 أسابيع)

    مهمة C1 — تنفيذ مفاتيح المطابقة (الحسّاسة بالترتيب)
        تنفيذ مفاتيح المطابقة المذكورة في المستند (حتى 10 مفاتيح) لكل من NetPurchases وNetSales.
        لكل مفتاح: كتابة اختبار وحدات يثبت أن السجلات المطابقة تُجري النقل/الطرح الصحيح.
        ناتج مقبول: نتائج NetPurchases تحتوي على القوائم A، B، orphan returns إلخ كما في المستند.
    مهمة C2 — توثيق وتسجيل الحركات
        لكل عملية مطابقة سجل، تسجل الحقول: matchedByKey, sourceRecordId, targetRecordId, matchedQty.
        ناتج مقبول: سجل audit trail يُمكّن الاستقصاء لاحقاً.

المرحلة D — تجهيز الجرد الفعلي ومعالجة Ending Inventory (2 أسابيع)

    مهمة D1 — تنظيف Physical_Inventory إلى قوائم E، F... بناءً على القواعد في المستند.
        ناتج مقبول: قوائم مفصولة E (كميات موجبة)، F (سالبة/صلاحية منتهية)، إلخ.
    مهمة D2 — تنفيذ منطق المطابقة بين الجرد الفعلي وصافي المشتريات
        تطبيق مفتاح المطابقة الأول ثم الثاني ... كما في المستند، مع حفظ أرقام السجل المتبادلة وتعديل الكميات في صافي المشتريات.
        ناتج مقبول: finalEndingInventoryList مطابق للمثال في المستند، وnetPurchasesList معدّل مع ملاحظات وحقول رقم السجل كما هو مطلوب.
    اختبار قبول: عند مدخلات تجريبية محددة، الناتج يجب أن يطابق ملف مرجعي.

المرحلة E — استحقاق الموردين (Supplier Payables) وتقارير الفائض (2 أسابيع)

    مهمة E1 — تنفيذ حساب الاستحقاق حسب القواعد (value rounding, zero floor when >= -999...).
        ناتج مقبول: جدول Supplier payables مع الأعمدة المطلوبة (مدين/دائن/الرصيد/المبلغ المستحق/الاحتياج/أصناف جديدة...) ومتوافق مع قواعِد المستند.
    مهمة E2 — تقرير فائض المخزون (3 أشهر)
        حساب المبيعات خلال آخر 90 يوماً، حساب فائض/احتياج، فئات "راكد تماما" و"مخزون زائد/ناقص" كما هو موصل.
        ناتج مقبول: تقرير لا يُنتج صفوفًا إذا لم تتوفر بيانات المبيعات مرجعية كافية — تحذير بدلاً من إخراج خاطئ.

المرحلة F — جودة، اختبارات، ونشر (1–2 أسابيع)

    مهمة F1 — كتابة اختبارات وحدة وتكامل تغطي كل المسارات (incl. orphan returns, negative qty, expiry).
    مهمة F2 — تنفيذ CI يتضمن: تشغيل linter, تشغيل الاختبارات، تشغيل مجموعة اختبارات على عينات Excel صغيرة وكبيرة.
    مهمة F3 — مراقبة الأداء (profiling) مع ملفات كبيرة، وتحديد النقاط الساخنة وإصلاحها.

قواعد وقائية/حماية ضد إنشاء تقارير بدون بيانات

    قبل توليد أي تقرير محاسبي نهائي (خصوصاً مالية/استحقاق) يجب التأكد من:
        أن ملفات الإدخال الأربعة متوفرة وتم اجتياز schema validation.
        أن الحقول المالية المطلوبة موجودة وصحيحة (الأفرادي، الاجمالي، الرصيد).
        أن عدد السجلات ذات الصلة > 0؛ إن لم يكن كذلك: إرجاع رسالة واضحة "لا يوجد بيانات كافية لإنشاء التقرير — مطلوب: ...".
        الاحتفاظ بكل تقارير الوسيط (logs, audit trail) بحيث يمكن الاستدلال على سبب عدم التوليد.
    سياسة الإخراج: لا يتم إنشاء ملفات Excel/CSV نهائية للتقارير المحاسبية إلا إذا مرت مجموعة اختبارات صحة البيانات (integrity checks).

تحسينات أداء تقنية (تطبيقية)

    استبدال عمليات البحث المتكررة داخل قوائم (nested loops) باستخدام هياكل فهرسة:
        خرائط (Map) بمفتاح مركب (رمز المادة|تاريخ الصلاحية) للوصول O(1).
        حفظ المشتريات المرتبة حسب تاريخ الشراء بحيث تُستخدم تقنية pointer advance بدلاً من إعادة البحث.
    استخدام معالجة مجزّأة (chunking/streaming) عند قراءة جداول Excel كبيرة، بدلاً من تحميل كل شيء في الذاكرة.
    استخدام مكتبة عددية (decimal.js أو Big.js) للتعامل مع المال بدقة وتطبيق قواعد round/trunc الواردة في المستند.
    قياس الأداء (benchmark) مع ملفات بحجم حقيقي وتحديد SLO (مثلاً: عملية كاملة لألف صف/ورقة لا تتجاوز X ثانية/ذاكرة < Y MB).

متطلبات اختبار وصيغ بيانات توضيحية

    إعداد مجموعة بيانات fixture واحدة لكل حالة:
        حالات مطابقة بسيطة (1:1) — للتأكد من المفاتيح الأساسية.
        حالة orphan returns (مرتجع لا يطابق) — يجب أن تنتقل إلى القائمة المقصودة.
        حالة صلاحيـة منتهية وكميات سالبة وفائض — يتحقق من قوائم F وB.
        حالة عدم كفاية بيانات للمبيعات (يضمن عدم توليد تقرير فائض).
    لكل fixture نحدد ملف Excel نموذجي وملف JSON مرجعي للناتج المتوقع. الاختبارات يجب أن تجري تلقائياً في CI.

مؤشرات قبول نهائية (Definition of Done)

    جميع البنود المذكورة في Accountinglogic.md مُنفَّذة ومغطّاة بالاختبارات (unit + integration).
    يتم التحقق من صحة الإدخال ورفض الملفات غير المطابقة مع رسائل خطأ مفصلة.
    لا توليد لتقارير مالية نهائية إن لم تتوافر البيانات المطلوبة — بدلاً من ذلك إنتاج تحذير/تقرير حالة.
    الأداء يجب أن يكون مقبولًا مع أحجام متوقعة (نقطة مرجعية متفق عليها) — أو على الأقل، وجود خطة تحسين واضحة ومطبقة.
    تغطية اختبارات تلقائية >= 80% على المنطق التجاري الأساسي، مع سيناريوهات Edge مثبتة.

ملاحظات تنفيذية على مستوى الكود (مقترحات سريعة)

    ملف src/logic/endingInventoryLogic.js:
        أرى منطقاً لمطابقة الجرد الفعلي لكن يحتاج إلى:
            تسجيل المفتاح الذي أدّى إلى المطابقة.
            استخدام hash-index قبل البحث linearly.
            ضمان أن تعديل كمية صافي المشتريات يتم في مكان مركزي وآمن (atomic update).
    ملف src/services/dataProcessingService.js:
        تأكيد تسلسل الاستدعاء: netPurchases → netSales → endingInventory → supplierPayables → bookInventory. إضافة حالات فشل مبكرة.
        توثيق وضوح الحاله التي يتم فيها دمج القوائم orphan returns (من أين ولماذا).
    إضافة modules:
        validator/ (schema validations)
        matcher/ (تنفيذ مفاتيح المطابقة، مع إمكانية إضافة/ترتيب المفتاح بسهولة)
        audit/ (تخزين السجل التفصيلي لكل تطابق وتعديل)

المخاطر ومقترحات التخفيف

    خطر: بيانات إدخال غير متوقعة أو تسميات أعمدة مختلفة (لغة/تشفير).
        تخفيف: إضافة layer تطبيع أسماء الأعمدة والنسخ الاحتياطي (mapping) مع تحذير للمستخدم.
    خطر: أداء سيئ على بيانات الإنتاج الكبيرة.
        تخفيف: قياس الأحجام الفعلية، تنفيذ فهرسة مسبقة، واختبار تحميل staging.
    خطر: اختلافات في قواعد المحاسبة غير موثقة.
        تخفيف: فتح قائمة أسئلة (RFC) لتحديد السلوك في الحالات الغامضة، وتوثيق القرار.

خلاصة موجزة قابلة للقراءة السريعة

    ما تم: راجعت المواصفات والجزء الحالي من الشيفرة؛ وجدت تنفيذًا جزئيًا لمنطق الجرد النهائي وبعض الدمج، لكن النتيجة ليست مطابقة 100% للمواصفات التفصيلية.
    ما ينبغي عمله فوراً: تنفيذ schema validation، إكمال NetPurchases/NetSales بمفاتيح المطابقة الواردة، إكمال منطق Ending Inventory وربط أرقام السجل، ومنع إنشاء تقارير بدون بيانات داعمة.
    كيف أصل إلى 100%: تقسيم العمل إلى مهام صغيرة (كما أعلاه)، إضافة اختبارات fixtures لكل حالة، تحسين الأداء باستخدام فهارس وstreaming، وتبني سياسة صارمة لإخراج التقارير فقط عند تحقق شروط الصحة