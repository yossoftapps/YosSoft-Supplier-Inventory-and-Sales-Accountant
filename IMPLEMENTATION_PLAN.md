# خطة تنفيذية شاملة لإصلاح وتحديث المشروع

## تحليل تقرير الأخطاء

بناءً على تقرير الأخطاء المفصل، تم تحديد النقاط التالية ك_areas رئيسية للتحسين:

1. **اكتمال المنطق المحاسبي** - بعض البنود في Accountinglogic.md غير مطبقة بالكامل
2. **التحقق من صحة البيانات** - عدم وجود طبقة تحقق صارمة عند الاستيراد
3. **إدارة حالات الحافة** - معالجة غير كافية لحالات اليتيم، الكميات السالبة، والصلاحيات المنتهية
4. **تتبع الارتباطات** - عدم وجود ضمان لعمليات ثنائية الاتجاه بين السجلات
5. **دقة الأرقام المالية** - استخدام غير صحيح لأنواع الأرقام وسياسات التقريب
6. **حماية توليد التقارير** - عدم وجود حماية ضد إنشاء تقارير بدون بيانات كافية
7. **اختبارات وحدات وتكامل** - غياب الاختبارات الشاملة
8. **أداء المنطق المطابق** - خوارزميات غير فعالة على مجموعات البيانات الكبيرة

## خطة تنفيذية مفصلة

### المرحلة A - إعداد البنية والملفات (3-5 أيام)

#### مهمة A1 - تعيين المواصفات إلى النموذج
- تحويل كل بند في Accountinglogic.md إلى مهام صغيرة قابلة للتنفيذ
- إنشاء قائمة مسائل (issues) مرقمة تغطي كل بند رئيسي
- مثال: "FR-04: NetPurchases - تطبيق 10 مفاتيح مطابقة"

#### مهمة A2 - تعريف مخطط التحقق
- تعريف مخطط JSON لكل جدول (purchases, Sales, Physical_Inventory, supplierbalances)
- إنشاء مكتبة تحقق قابلة للتشغيل قبل المعالجة

### المرحلة B - استيراد البيانات والتحقق (1 أسبوع)

#### مهمة B1 - طبقة استيراد Excel
- التأكد من قراءة الأوراق والأسماء المذكورة بشكل صحيح
- تنفيذ التحقق من صحة المخطط مع رسائل خطأ واضحة

#### مهمة B2 - تطبيع البيانات
- توحيد صيغ التواريخ (yyyy-mm-dd)
- تحويل الأرقام وفق السياسات المحددة
- إزالة المسافات وتوحيد التنسيق

### المرحلة C - بناء NetPurchases وNetSales (2 أسابيع)

#### مهمة C1 - تنفيذ مفاتيح المطابقة
- تنفيذ المفاتيح العشرة المذكورة في المستند لكل من NetPurchases وNetSales
- كتابة اختبارات وحدات لكل مفتاح

#### مهمة C2 - توثيق وتسجيل الحركات
- تسجيل كل عملية مطابقة مع تفاصيل المصدر والهدف
- إنشاء سجل تدقيق يمكن الاستقصاء لاحقاً

### المرحلة D - تجهيز الجرد الفعلي ومعالجة Ending Inventory (2 أسابيع)

#### مهمة D1 - تنظيف Physical_Inventory
- تنفيذ القواعد المحددة لتحويل البيانات إلى قوائم E، F

#### مهمة D2 - تنفيذ منطق المطابقة
- تطبيق مفاتيح المطابقة مع حفظ أرقام السجل المتبادلة
- ضمان تعديل الكميات بشكل آمن ومركزي

### المرحلة E - استحقاق الموردين وتقارير الفائض (2 أسابيع)

#### مهمة E1 - تنفيذ حساب الاستحقاق
- تطبيق القواعد المحددة (value rounding, zero floor when >= -999...)

#### مهمة E2 - تقرير فائض المخزون
- حساب المبيعات خلال آخر 90 يوماً
- تنفيذ الفئات المحددة (راكد تماماً، مخزون زائد/ناقص)

### المرحلة F - جودة، اختبارات، ونشر (1-2 أسابيع)

#### مهمة F1 - كتابة الاختبارات
- اختبارات وحدة وتكامل تغطي كل المسارات

#### مهمة F2 - تنفيذ CI
- تشغيل linter، الاختبارات، ومجموعة اختبارات على عينات Excel

#### مهمة F3 - مراقبة الأداء
- تحديد النقاط الساخنة وإصلاحها

## أولويات التنفيذ

### أولوية عالية (1-2 أسابيع)
1. تنفيذ التحقق الصارم لملفات Excel عند الاستيراد
2. إكمال منطق NetPurchases وNetSales وفق المفاتيح العشرة
3. إكمال منطق تصنيع Ending Inventory
4. إضافة حماية صريحة ضد توليد تقارير بدون بيانات كافية

### أولوية متوسطة (2-4 أسابيع)
1. استخدام نوع عدد دقيق (decimal) للمال وسياسة rounding موثقة
2. إضافة نظام تتبع أصول السجلات
3. بناء مجموعة اختبارات وحدات وتكامل شاملة

### أولوية منخفضة (بعد التشغيل المستقر)
1. تحسين الأداء على ملفات كبيرة
2. تقارير تحليلية إضافية

## تحسينات تقنية مقترحة

### تحسينات الأداء
- استبدال عمليات البحث المتكررة باستخدام هياكل فهرسة
- استخدام معالجة مجزأة (chunking/streaming) للملفات الكبيرة
- استخدام مكتبة عددية (decimal.js) للتعامل مع المال بدقة

### تحسينات البنية
- إنشاء وحدات منظمة (validator/, matcher/, audit/)
- تأكيد التسلسل الصحيح لاستدعاء الخدمات
- توثيق الحالات التي يتم فيها دمج القوائم

## مؤشرات القبول النهائية

1. جميع البنود في Accountinglogic.md مطبقة ومغطاة بالاختبارات
2. التحقق من صحة الإدخال ورفض الملفات غير المطابقة
3. عدم توليد تقارير مالية نهائية بدون بيانات كافية
4. أداء مقبول مع أحجام متوقعة
5. تغطية اختبارات تلقائية >= 80% على المنطق التجاري الأساسي

## خطة العمل التدريجية

سيتم تنفيذ هذه الخطة تدريجياً مع إعطاء الأولوية للعناصر التي تؤثر على دقة النتائج المحاسبية أولاً، ثم تحسين واجهة المستخدم والوظائف الإضافية.